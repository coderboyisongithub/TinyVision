cmake_minimum_required(VERSION 3.10)
project(TinyTorch_pybind)
set(CMAKE_CXX_STANDARD 20)
set(CMAKE_CXX_STANDARD_REQUIRED ON)
add_subdirectory(../../thirdparty/pybind11 ${CMAKE_CURRENT_BINARY_DIR}/../thirdparty/pybind11)

# 源文件
file(GLOB_RECURSE TinyTorch_pybind_src "bind.cpp")

# 创建 Python 模块
add_library(TinyTorch_pybind MODULE
        ${TinyTorch_pybind_src}
        )

# 查找依赖的核心库
target_link_libraries(TinyTorch_pybind PRIVATE
        TinyTorch
        pybind11::module
        pybind11::python_link_helper
        )

if(WIN32)
    # 将依赖库的 DLL 目录添加到模块的链接路径
    set(DEPS_DLL_DIRS
            "${CUDA_TOOLKIT_ROOT_DIR}/bin"
            "${CUDNN_LIBRARY_DIR}"
            "${OpenCV_DIR}/bin"
            "../../thirdparty/OpenBLAS/win64-64/bin" # 根据实际路径调整
            )

    # 将路径转换为 Windows 格式并设置到链接标志
    file(TO_NATIVE_PATH "${DEPS_DLL_DIRS}" NATIVE_DLL_DIRS)
    string(REPLACE ";" "\\;" NATIVE_DLL_DIRS_ESC "${NATIVE_DLL_DIRS}")
    set_target_properties(TinyTorch_pybind PROPERTIES
            LINK_FLAGS "/DELAYLOAD:cusolver.dll /DELAYLOAD:cublas.dll -LIBPATH:\"${NATIVE_DLL_DIRS_ESC}\""
            )
endif()

# 设置 Python 绑定属性
set_target_properties(TinyTorch_pybind PROPERTIES
        PREFIX ""
        OUTPUT_NAME "pytt"
        CXX_VISIBILITY_PRESET "hidden"
        VISIBILITY_INLINES_HIDDEN ON
        )

if(WIN32)
    set_target_properties(TinyTorch_pybind PROPERTIES SUFFIX ".pyd")
else()
    set_target_properties(TinyTorch_pybind PROPERTIES SUFFIX ".so")
endif()

# 查找 Python
find_package(Python 3.12 EXACT REQUIRED COMPONENTS Interpreter Development)

target_include_directories(TinyTorch_pybind PRIVATE ${Python_INCLUDE_DIRS} ../../TinyTorch)
target_link_libraries(TinyTorch_pybind PRIVATE ${Python_LIBRARIES} TinyTorch)

if(NOT Python_EXECUTABLE)

    find_program(Python_EXECUTABLE
            NAMES python3 python
            PATHS "D:/miniconda"
            DOC "Python interpreter path"
            )
    if(Python_EXECUTABLE)
        set(Python3_EXECUTABLE ${Python_EXECUTABLE} CACHE PATH "Python 3 interpreter" FORCE)
    endif()
endif()

# 编译设置
if(CMAKE_BUILD_TYPE STREQUAL "Release")
    target_compile_definitions(TinyTorch_pybind PRIVATE NDEBUG)
else()
    target_compile_definitions(TinyTorch_pybind PRIVATE DEBUG)
endif()

if(MSVC)
    target_compile_options(TinyTorch_pybind PRIVATE /bigobj)
endif()

# 安装规则
install(TARGETS TinyTorch_pybind
        LIBRARY DESTINATION lib/python/site-packages
        ARCHIVE DESTINATION lib/python/site-packages
        RUNTIME DESTINATION bin
        )